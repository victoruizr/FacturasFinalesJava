# Facturas

MANUAL --> https://drive.google.com/file/d/1fHsUaiSDFAEJxQoJh1bUNhGMLOQPjhxg/view?usp=sharing

-----------------------------------------------------------------------------------------------------
create or replace
PROCEDURE procedimientoEstadisticas (FECHA1 IN DATE, FECHA2 IN DATE, DNICIF1 IN VARCHAR2, DNICIF2 IN VARCHAR2) IS
  CURSOR C1 IS SELECT TO_CHAR(FCAB.FECHAFAC,'YYYY') AS ANIO,
    TO_CHAR(FCAB.FECHAFAC,'mm') AS MES_NUM,
    TO_CHAR(FCAB.FECHAFAC,'Month')AS MES_NOM,
    FCAB.DNICIF AS DNICIF
    FROM  
    FACTURAS_CAB FCAB
    WHERE FCAB.FECHAFAC BETWEEN FECHA1 AND FECHA2
    GROUP BY TO_CHAR(FCAB.FECHAFAC,'YYYY'),TO_CHAR(FCAB.FECHAFAC,'mm'),TO_CHAR(FCAB.FECHAFAC,'Month'),FCAB.DNICIF;
    
  CURSOR C2 IS SELECT C.DNICIF,C.NOMBRECLI
     FROM CLIENTES C
     INNER JOIN FACTURAS_CAB FCAB ON FCAB.DNICIF=C.DNICIF
     WHERE (C.DNICIF BETWEEN DNICIF1 AND DNICIF2)
     AND (FCAB.FECHAFAC BETWEEN FECHA1 AND FECHA2)     
     GROUP BY C.DNICIF,C.NOMBRECLI
     ORDER BY C.DNICIF;
     
  CURSOR C3 IS SELECT FCAB.DNICIF as DNICIF,
    SUM(FTOT.BASEIMP) AS SUMA_BASE,
    SUM(FTOT.IMP_DTO) AS SUMA_DTOS,
    SUM(FTOT.IMP_IVA) AS SUMA_IVA,
    SUM(TOTALFAC) AS SUMA_TOTALES
    FROM FACTURAS_TOT FTOT INNER JOIN FACTURAS_CAB FCAB ON FTOT.NUMFAC=FCAB.NUMFAC
    GROUP BY FCAB.DNICIF;
  
     
  ANIO ESTADISTICAS_CLIENTES.ANIO%TYPE;
  MES_NUM ESTADISTICAS_CLIENTES.MES_NUM%TYPE;
  MES_NOM ESTADISTICAS_CLIENTES.MES_NOM%TYPE;
  DNICIF ESTADISTICAS_CLIENTES.DNICIF%TYPE;
  NOMBRECLI ESTADISTICAS_CLIENTES.NOMBRECLI%TYPE;
  SUMA_BASE ESTADISTICAS_CLIENTES.SUMA_BASE%TYPE;
  SUMA_DTOS ESTADISTICAS_CLIENTES.SUMA_DTOS%TYPE;
  SUMA_IVA ESTADISTICAS_CLIENTES.SUMA_IVA%TYPE;
  SUMA_TOTALES ESTADISTICAS_CLIENTES.SUMA_TOTALES%TYPE;
  
  BEGIN
  DELETE FROM ESTADISTICAS_CLIENTES;
    for clien in C2 loop
      
      for fechas in C1 loop
        IF fechas.DNICIF=clien.DNICIF THEN
          ANIO:=fechas.ANIO;
          MES_NUM:=fechas.MES_NUM;
          MES_NOM:=fechas.MES_NOM;
        END IF;
      END LOOP;
      for sumas in C3 loop
        IF sumas.DNICIF=clien.DNICIF THEN
          SUMA_BASE:=sumas.SUMA_BASE;
          SUMA_DTOS:=sumas.SUMA_DTOS;
          SUMA_IVA:=sumas.SUMA_IVA;
          SUMA_TOTALES:=sumas.SUMA_TOTALES;
        END IF;
      END LOOP;
      DNICIF:=clien.DNICIF;
      NOMBRECLI:=clien.NOMBRECLI;
      DBMS_OUTPUT.PUT_LINE(DNICIF);
   INSERT INTO ESTADISTICAS_CLIENTES VALUES(ANIO,MES_NUM,MES_NOM,DNICIF,NOMBRECLI,SUMA_BASE,SUMA_DTOS,SUMA_IVA,SUMA_TOTALES);   
  end loop;

END;

